<!DOCTYPE html>
<html>
    <head>
        
        <script src="deps/glMatrix-0.9.5.min.js"></script>
        <script src="glt.js"></script>

        <style type="text/css">
        body { background: #333; }
        canvas { background: #eee; }

        </style>

        <script id="vs" type="x-shader/x-vertex">
            
            attribute vec2 aPosition;
            varying vec2 vTexCoord;

            void main() {
                gl_Position = vec4(aPosition, 0, 1);
                vTexCoord = aPosition;
            }
        
        </script>


        <script id="fs" type="x-shader/x-fragment">
            
            #ifdef GL_ES
                precision highp float;
            #endif

            uniform sampler2D uSampler;

            varying vec2 vTexCoord;

            void main() {
                gl_FragColor = texture2D(uSampler, vTexCoord);
            }
        
        </script>



        <script id="vsUpdate" type="x-shader/x-vertex">
            
            attribute vec2 aPosition;
            varying vec2 vTexCoord;

            void main() {
                gl_Position = vec4(aPosition, 0, 1);
                vTexCoord = aPosition;
            }
        
        </script>


        <script id="fsUpdate" type="x-shader/x-fragment">
            
            #ifdef GL_ES
                precision highp float;
            #endif

            uniform sampler2D uSampler;
            varying vec2 vTexCoord;
    

            void main() {

                vec4 pos = texture2D(uSampler,vTexCoord);
                pos.x += 0.0002;
                pos.y += 0.002;


                gl_FragColor = pos;
            }
        
        </script>






        <script id="vsDraw" type="x-shader/x-vertex">
            
            attribute vec2 aPosition;
            uniform sampler2D uState;


            void main() {
                gl_PointSize = 5.0;
                gl_Position = texture2D(uState, vec2(0.0, 0.0));
            }
        
        </script>


        <script id="fsDraw" type="x-shader/x-fragment">
            
            #ifdef GL_ES
                precision highp float;
            #endif

            void main() {
                gl_FragColor = vec4(0,0,0,1);
            }
        
        </script>






        <script>
            var     canvas,
                    gl,
                    program, pUpdate, pDraw,
                    texture1, texture2, textures,
                    framebuffer,
                    screenQuad,
                    debugQuad,
                    i = 1;

            function init() {
                
                glt.raf();

                canvas = document.getElementById('canvas');
                    
                
                gl = glt.getGL(canvas, {premultipliedAlpha: true});
                
                gl.getExtension('OES_texture_float');
                gl.disable(gl.DEPTH_TEST);
                
                /** UPDATE PROGRAM **************************************************/
                var vs = glt.compileShader(gl, 'vsUpdate');
                var fs = glt.compileShader(gl, 'fsUpdate');
                pUpdate = glt.createProgram(gl, [vs,fs]);
                
                pUpdate.vertexPosAttrib = gl.getAttribLocation(pUpdate, 'aPosition');
                pUpdate.samplerUniform = gl.getUniformLocation(pUpdate, 'uSampler');


                /** DRAW PROGRAM **************************************************/
                vs = glt.compileShader(gl, 'vsDraw');   
                fs = glt.compileShader(gl, 'fsDraw');
                pDraw = glt.createProgram(gl, [vs,fs]);    

                pDraw.vertexPosAttrib = gl.getAttribLocation(pDraw, 'aPosition');
                pUpdate.samplerUniform = gl.getUniformLocation(pUpdate, 'uSampler');
                gl.enableVertexAttribArray(pDraw.vertexPosAttrib);

                
                /** DEBUG PROGRAM **************************************************/
                vs = glt.compileShader(gl, 'vs');   
                fs = glt.compileShader(gl, 'fs');
                program = glt.createProgram(gl, [vs,fs]);    

                program.vertexPosAttrib = gl.getAttribLocation(program, 'aPosition');
                program.samplerUniform = gl.getUniformLocation(program, 'uSampler');
                gl.enableVertexAttribArray(program.vertexPosAttrib);





               

                
                var image = new Image();
                image.onload = function() {

                    var stateTexSize = 1;
 
                    var stateData = new Float32Array(stateTexSize * stateTexSize * 3);
                    stateData[0] = 0.0;
                    stateData[1] = 0.0;
                    stateData[2] = Math.random();


                  
                    gl.useProgram(program);

                    texture = glt.createStateTexture(gl);
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, stateTexSize, stateTexSize, 0, gl.RGB, gl.FLOAT, stateData);


                    var q = glt.screenQuad(gl);
                    gl.vertexAttribPointer(program.vertexPosAttrib, q.numComponents, gl.FLOAT, false, 0, 0);
                    gl.drawArrays(gl.TRIANGLE_STRIP, 0, q.numItems);

                    texture2 = glt.createStateTexture(gl);
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, stateTexSize, stateTexSize, 0, gl.RGB, gl.FLOAT, null);

                    framebuffer = gl.createFramebuffer();
                    screenQuad = glt.screenQuad(gl);
                    debugQuad = glt.createArrayBuffer(gl, [ 0.5, -0.5,   1, -0.5,   0.5, -1,   1, -1 ], 2); 
                    points = glt.createArrayBuffer(gl, [0.0, 0.0], 2);
                    

                    textures = [texture, texture2];


                    draw();
                    //setTimeout(draw, 1000);
                }   
                image.src = 'logo.png'                
            }

            function draw() {

                requestAnimFrame(draw);

                

                /** DRAW TO FRAMEBUFFER --> UPDATE *************************************************/

                gl.useProgram(pUpdate);

                gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
                
                gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture2, 0);

                if( 2 % i == 0 ) {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture);
                    gl.uniform1i(pUpdate.samplerUniform, 0);
                }else {
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture);
                    gl.uniform1i(pUpdate.samplerUniform, 1);
                }
                

                gl.clear(gl.COLOR_BUFFER_BIT);

                gl.bindBuffer(gl.ARRAY_BUFFER, screenQuad);
                gl.vertexAttribPointer(pUpdate.vertexPosAttrib, screenQuad.numComponents, gl.FLOAT, false, 0, 0);   
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, screenQuad.numItems);
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);

               


                /** DRAW TO DEBUG  *************************************************/

                gl.useProgram(program);


                if( 2 % i == 0 ) {
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(program.samplerUniform, 1);
                }else {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(program.samplerUniform, 0);
                }

                gl.bindBuffer(gl.ARRAY_BUFFER, debugQuad);
                gl.vertexAttribPointer(program.vertexPosAttrib, debugQuad.numComponents, gl.FLOAT, false, 0, 0);   
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, debugQuad.numItems);

                
                /** DRAW POINTS  *************************************************/

                gl.useProgram(pDraw);


                if( 2 % i == 0 ) {
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(pDraw.samplerUniform, 1);
                }else {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(pDraw.samplerUniform, 0);
                }
                
                gl.bindBuffer(gl.ARRAY_BUFFER, points);
                gl.vertexAttribPointer(pDraw.vertexPosAttrib, points.numComponents, gl.FLOAT, false, 0, 0);
                gl.drawArrays(gl.POINTS, 0, points.numItems);


                var t = texture2;
                texture2 = texture;
                texture = t;

                i++;
        }

        </script>

    </head>

    <body onload="init()">
        <canvas id="canvas" width="400" height="300" />
    </body>


</html>
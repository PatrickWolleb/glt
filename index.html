<!DOCTYPE html>
<html>
    <head>
        
        <script src="deps/glMatrix-0.9.5.min.js"></script>
        <script src="glt.js"></script>

        <style type="text/css">
        body { background: #333; }
        canvas { background: #eee; }

        </style>

        <script id="vs" type="x-shader/x-vertex">
            
            attribute vec2 aPosition;
            varying vec2 vTexCoord;

            void main() {
                gl_Position = vec4(aPosition, 0, 1);
                vTexCoord = aPosition;
            }
        
        </script>


        <script id="fs" type="x-shader/x-fragment">
            
            #ifdef GL_ES
                precision highp float;
            #endif

            uniform sampler2D uSampler;

            varying vec2 vTexCoord;

            void main() {
                gl_FragColor = texture2D(uSampler, vTexCoord);
            }
        
        </script>



        <script id="vsUpdate" type="x-shader/x-vertex">
            
            attribute vec2 aPosition;
            varying vec2 vTexCoord;

            void main() {
                gl_Position = vec4(aPosition, 0, 1);
                vTexCoord = aPosition;
            }
        
        </script>


        <script id="fsUpdate" type="x-shader/x-fragment">
            
            #ifdef GL_ES
                precision highp float;
            #endif

            uniform sampler2D uSampler;
            varying vec2 vTexCoord;
    

            void main() {
                float offset = 0.0;
                float uResolution = 2.0;
                vec4 pos = texture2D(uSampler, (gl_FragCoord.xy + vec2(offset, 1)) / uResolution);
                pos.x += 0.0002;
                pos.y -= 0.002;


                gl_FragColor = pos;
            }
        
        </script>






        <script id="vsDraw" type="x-shader/x-vertex">
            
            attribute vec2 aPosition;
            varying vec2 vTexCoord;
            uniform sampler2D uState;

            void main() {
                gl_PointSize = 5.0;
                gl_Position = texture2D(uState, aPosition);
                vTexCoord = aPosition;
            }
        
        </script>


        <script id="fsDraw" type="x-shader/x-fragment">
            
            #ifdef GL_ES
                precision highp float;
            #endif

            void main() {
                gl_FragColor = vec4(1,1,1,1);
            }
        
        </script>






        <script>
            var     canvas,
                    gl,
                    program, pUpdate, pDraw,
                    texture1, texture2, textures,
                    framebuffer,
                    screenQuad,
                    debugQuad,
                    i = 1,
                    stateTexSize = 2,
                    image = new Image();
                    image.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAIAAAD91JpzAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjE1NTdBRDlDMDkzMzExRTM4RDZBQTQ5MzlCQzE2QUVFIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjE1NTdBRDlEMDkzMzExRTM4RDZBQTQ5MzlCQzE2QUVFIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NUMxOTFDRkYwOTIwMTFFMzhENkFBNDkzOUJDMTZBRUUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NUMxOTFEMDAwOTIwMTFFMzhENkFBNDkzOUJDMTZBRUUiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6RL2zbAAAAGUlEQVR42mL6z8DA8N+P8f86BsZf/wECDAAk4QX3y2+LyQAAAABJRU5ErkJggg==';

            function init() {
                

                

                glt.raf();

                canvas = document.getElementById('canvas');
                    
                
                gl = glt.getGL(canvas, {premultipliedAlpha: true});
                
                gl.getExtension('OES_texture_float');
                gl.disable(gl.DEPTH_TEST);
                


                /** UPDATE PROGRAM **************************************************/
                var vs = glt.compileShader(gl, 'vsUpdate');
                var fs = glt.compileShader(gl, 'fsUpdate');
                pUpdate = glt.createProgram(gl, [vs,fs]);
                
                pUpdate.vertexPosAttrib = gl.getAttribLocation(pUpdate, 'aPosition');
                pUpdate.samplerUniform = gl.getUniformLocation(pUpdate, 'uSampler');



                /** DRAW PROGRAM **************************************************/
                vs = glt.compileShader(gl, 'vsDraw');   
                fs = glt.compileShader(gl, 'fsDraw');
                pDraw = glt.createProgram(gl, [vs,fs]);    
               
                pDraw.vertexPosAttrib = gl.getAttribLocation(pDraw, 'aPosition');
                pDraw.samplerUniform = gl.getUniformLocation(pDraw, 'uSampler');
                gl.enableVertexAttribArray(pDraw.vertexPosAttrib);

                

                /** DEBUG PROGRAM **************************************************/
                vs = glt.compileShader(gl, 'vs');   
                fs = glt.compileShader(gl, 'fs');
                program = glt.createProgram(gl, [vs,fs]);    
                
                program.vertexPosAttrib = gl.getAttribLocation(program, 'aPosition');
                program.samplerUniform = gl.getUniformLocation(program, 'uSampler');
                gl.enableVertexAttribArray(program.vertexPosAttrib);





                var stateData = new Float32Array(stateTexSize * stateTexSize* 3);

                for(var i = 0; i < stateTexSize*stateTexSize; ++i) {
                    var base = i * 3;
                    stateData[base] = Math.random();
                    stateData[base + 1] = Math.random();
                    stateData[base + 2] = Math.random();
                }

                

               
              
                gl.useProgram(program);

                texture = glt.createStateTexture(gl);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, texture);
                gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
                
                //gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image)
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, stateTexSize, stateTexSize, 0, gl.RGB, gl.FLOAT, stateData);

                var q = glt.createArrayBuffer(gl, [
                    -0.5,-0.5,   0.5, -0.5,   -0.5, 0.5,   0.5, 0.5
                    ], 2);
                gl.vertexAttribPointer(program.vertexPosAttrib, q.numComponents, gl.FLOAT, false, 0, 0);

                var indices = [0,1,2,    1,3,2];
                var indexBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER , indexBuffer);
                gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);
                indexBuffer.numComponents = 1;
                indexBuffer.numItems = 6;



               

                gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
                gl.drawElements(gl.TRIANGLES, indexBuffer.numItems, gl.UNSIGNED_SHORT, 0);

                //gl.drawArrays(gl.TRIANGLE_STRIP, 0, q.numItems);





                

                texture2 = glt.createStateTexture(gl);
                gl.activeTexture(gl.TEXTURE1);
                gl.bindTexture(gl.TEXTURE_2D, texture2);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, stateTexSize, stateTexSize, 0, gl.RGB, gl.FLOAT, null);

                framebuffer = gl.createFramebuffer();
                screenQuad = glt.screenQuad(gl);
                debugQuad = glt.createArrayBuffer(gl, [ 0.5, -0.5,   1, -0.5,   0.5, -1,   1, -1 ], 2); 
                points = glt.createArrayBuffer(gl, [0.0, 0.0, 0.1, 0.1], 2);
                

                textures = [texture, texture2];


                   draw();
                    //setTimeout(draw, 1000);
                            
            }

            function draw() {

                requestAnimFrame(draw);

                

                /** DRAW TO FRAMEBUFFER --> UPDATE *************************************************/

                gl.useProgram(pUpdate);
                gl.viewport(0, 0, stateTexSize * 2, stateTexSize * 2);
                gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
                
                gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture2, 0);

                if( 2 % i == 0 ) {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture);
                    gl.uniform1i(pUpdate.samplerUniform, 0);
                }else {
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture);
                    gl.uniform1i(pUpdate.samplerUniform, 1);
                }
                

                gl.clear(gl.COLOR_BUFFER_BIT);

                gl.bindBuffer(gl.ARRAY_BUFFER, screenQuad);
                gl.vertexAttribPointer(pUpdate.vertexPosAttrib, screenQuad.numComponents, gl.FLOAT, false, 0, 0);   
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, screenQuad.numItems);
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                 gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
               


                /** DRAW TO DEBUG  *************************************************/

                gl.useProgram(program);


                if( 2 % i == 0 ) {
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(program.samplerUniform, 1);
                }else {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(program.samplerUniform, 0);
                }

                gl.bindBuffer(gl.ARRAY_BUFFER, screenQuad);
                gl.vertexAttribPointer(program.vertexPosAttrib, screenQuad.numComponents, gl.FLOAT, false, 0, 0);   
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, screenQuad.numItems);

                
                /** DRAW POINTS  *************************************************/
                
                gl.useProgram(pDraw);


                if( 2 % i == 0 ) {
                    gl.activeTexture(gl.TEXTURE1);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(pDraw.samplerUniform, 1);
                }else {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, texture2);
                    gl.uniform1i(pDraw.samplerUniform, 0);
                }
                
                gl.bindBuffer(gl.ARRAY_BUFFER, points);
                gl.enableVertexAttribArray(pDraw.vertexPosAttrib);
                gl.vertexAttribPointer(pDraw.vertexPosAttrib, points.numComponents, gl.FLOAT, false, 0, 0);
                gl.drawArrays(gl.POINTS, 0, points.numItems);


                var t = texture2;
                texture2 = texture;
                texture = t;

                i++;
        }

        </script>

    </head>

    <body onload="init()">
        <canvas id="canvas" width="400" height="300" />
    </body>


</html>